<h1>현재 재생목록</h1>
<ol class='playlist'>
<% @musics.each do |m| %>
        <li><%=link_to "#{m.title}", "https://www.youtube.com/watch?v=#{m.vid}"%></li>
<% end %>
</ol>
<div id="player"></div>

<script>
    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);
    var player;
    var playlist = <%= raw @vids %>
    // var previousIndex = 1;

    $(window).load(function(){
      player = new YT.Player('player', {
            playerVars : {
                playlist: playlist.join(','),
            },
            events: {
              onStateChange: function(event) {
                    if(event.data == -1) {
                        console.log("gogo")
                        // get current video index
                        var index = player.getPlaylistIndex();
                        // update when playlists do not match
                        if(player.getPlaylist().length != playlist.length) {
                          // update playlist and start playing at the proper index
                          player.loadPlaylist(playlist, previousIndex+1);
                        }
                        previousIndex = index;
                    }
                }
        }
      });
    });

    setTimeout(function() {
      player.playVideo();
      player.setLoop(true);
    }, 3000);

    // 우선 예약 코드
    function super_booking(data) {
      playlist.splice(previousIndex, 0 ,data.vid)
    }



    function music_inserted(data) {
      playlist.push(data.vid);
      $('.playlist').append(`
        <li><a href="https://www.youtube.com/watch?v=${data.vid}">${data.title}</a></li>
      `);
    }

    var pusher = new Pusher("<%= ENV["pusher_key"] %>", {
      cluster: "<%= ENV["pusher_cluster"] %>",
      encrypted: true
    });

    var channel = pusher.subscribe('dashboard');
    channel.bind('create', function(data) {
      console.log(data);
      console.log("재생목록 생성!");
      if (data.status == 0){
        music_inserted(data);
      }else if (data.status == 1){
        super_booking(data);
      }
    });
</script>
